<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>JSQL Playground</title>
        <link href="https://unpkg.com/brixi@^0.5/brixi.min.css" rel="stylesheet" />
        <link href="/input.css" rel="stylesheet" />
        <style>
            * {
                box-sizing: border-box;
            }
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
                color: var(--grey-800);
            }
        </style>
    </head>
    <body class="w-screen h-screen overflow-hidden bg-grey-200" flex="items-center justify-center">
        <form class="bg-white radius-0.5 p-1 border-1 border-solid border-grey-300 shadow-md max-w-full w-768">
            <input-component class="block w-full">
                <label for="query">SQL Query</label>
                <input type="text" id="query" autocapitalize="off" autocomplete="off" required />
            </input-component>
        </form>
        <script type="module">
            import db from "./jsql.js";
            db.start({
                schema: {
                    name: "app",
                    version: 1,
                    tables: [
                        {
                            name: "cards",
                            keyPath: "id",
                            columns: [
                                {
                                    key: "id",
                                    unique: true,
                                },
                                {
                                    key: "name",
                                },
                                {
                                    key: "layout",
                                },
                                {
                                    key: "colors",
                                },
                                {
                                    key: "legalities",
                                },
                                {
                                    key: "rarity",
                                },
                                {
                                    key: "keywords",
                                },
                                {
                                    key: "front",
                                },
                                {
                                    key: "back",
                                },
                                {
                                    key: "type",
                                },
                                {
                                    key: "subtypes",
                                },
                                {
                                    key: "texts",
                                },
                                {
                                    key: "manaCosts",
                                },
                                {
                                    key: "totalManaCost",
                                },
                                {
                                    key: "faceNames",
                                },
                                {
                                    key: "flavorTexts",
                                },
                                {
                                    key: "toughness",
                                },
                                {
                                    key: "power",
                                },
                            ],
                        },
                    ],
                },
                dbWorker: `./jsql.worker.js`,
                streamWorker: `./stream.worker.js`,
            })
                .then(() => {
                    if (!localStorage.getItem("loaded-once")) {
                        db.ingest(`${location.origin}/cards.jsonl`, "cards", "NDJSON").then(() => {
                            alert("Application is ready");
                            localStorage.setItem("loaded-once", true);
                        });
                    } else {
                        db.query("INSERT INTO cards VALUES ($value)", {
                            value: {"name":"1996 World Champion","layout":"normal","colors":["B","G","R","U","W"],"legalities":{"standard":"not_legal","future":"not_legal","historic":"not_legal","gladiator":"not_legal","pioneer":"not_legal","explorer":"not_legal","modern":"not_legal","legacy":"not_legal","pauper":"not_legal","vintage":"not_legal","penny":"not_legal","commander":"not_legal","brawl":"not_legal","historicbrawl":"not_legal","alchemy":"not_legal","paupercommander":"not_legal","duel":"not_legal","oldschool":"not_legal","premodern":"not_legal"},"rarity":"rare","keywords":[],"front":"https://divinedrop.nyc3.cdn.digitaloceanspaces.com/cards/1996-world-champion-front.png","back":null,"type":"Summon","subtypes":["Legend"],"texts":["Cannot be the target of spells or effects. World Champion has power and toughness equal to the life total of target opponent.\n{0}: Discard your hand to search your library for 1996 World Champion and reveal it to all players. Shuffle your library and put 1996 World Champion on top of it. Use this ability only at the beginning of your upkeep, and only if 1996 World Champion is in your library."],"manaCosts":["{W}{U}{B}{R}{G}"],"totalManaCost":5,"faceNames":["1996 World Champion"],"flavorTexts":["It takes great sacrifice to make it to the top."],"toughness":"*","power":"*","id":"1996-world-champion-test", test: true}
                        });
                        db.query("UPDATE cards SET test = 'hello world' WHERE rarity = 'mythic'");
                    }
                })
                .catch((e) => {});

            const form = document.body.querySelector("form");
            const input = document.body.querySelector("input");
            form.addEventListener("submit", async (e) => {
                e.preventDefault();
                try {
                    const value = input.value;
                    const start = performance.now();
                    const output = await db.query(
                        value,
                        {
                            cost: 4,
                        },
                        true
                    );
                    const stop = performance.now();
                    console.log(value);
                    console.log("Results:", output);
                    console.log(`‚è± Performed in ${((stop - start) / 1000).toFixed(3)} sec`);
                } catch (e) {
                    console.error(e);
                }
            });
        </script>
    </body>
</html>
